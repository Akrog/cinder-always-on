<!DOCTYPE html>
<html>
  <head>
    <title>Cinder Always On - BCN OS Summit</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <link rel="stylesheet" href="slides.css"></link>
  </head>
  <body>
    <textarea id="source">

layout: true
name: title_layout
class: title_slide

---

layout: true
name: section_layout
class: section_slide

---

layout: true
name: agenda_layout
class: content_slide agenda_slide

---

layout: true
name: thank_you
class: thank_you

---

layout: true
name: content_layout
class: content_slide

---

template: title_layout

# CINDER ALWAYS ON<br>Reliability And Scalability Guide

## Barcelona OpenStack Summit

Michal Dulko - Software Engineer - Intel Corp.<br>
Gorka Eguileor - Senior Software Engineer - Red Hat, Inc.<br>
<br>
26-Oct-2016<br>

---

template: agenda_layout

# AGENDA

- Overview of Cinder Architecture
- HA of Cinder Services
  - cinder-volume A/A HA
- Rolling Upgrades
- HA of Storage: Replication
- Tips & Tricks
- Q&A

---

template: section_layout

ARCHITECTURE OVERVIEW

---

# Cinder Architecture

## A.K.A "Initial fork out of Nova."

.fill-width[![Insert graphic here](assets/architecture/architecture1.svg)]

---

# Cinder Architecture

## Status reporting and volume creation flow.

.fill-width[![Insert graphic here](assets/architecture/architecture2.svg)]

---

# Cinder Architecture

## Management of existing volumes.

.fill-width[![Insert graphic here](assets/architecture/architecture3.svg)]

---

# Cinder Architecture

## cinder-volume<->cinder-volume communication (e.g. migration).

.fill-width[![Insert graphic here](assets/architecture/architecture4.svg)]

---

# Cinder Architecture

## Host boundaries - local drivers: LVM, NFS, Block Device Driver (!)…

.fill-width[![Insert graphic here](assets/architecture/architecture5.svg)]

---

# Cinder Architecture

## cinder-backup service (optional).

.fill-width[![Insert graphic here](assets/architecture/architecture6.svg)]

---

# Cinder Architecture

## Pre-Mitaka flow - cinder-backup talks directly to backend (cinder-volume colocation).

.fill-width[![Insert graphic here](assets/architecture/architecture7.svg)]

---

# Cinder Architecture

## Post-Mitaka flow - cinder-backup communicates with cinder-volume.

.fill-width[![Insert graphic here](assets/architecture/architecture8.svg)]

---

# Cinder Architecture

## Post-Mitaka flow - cinder-bakup communicates with cinder-volume.

.fill-width[![Insert graphic here](assets/architecture/architecture9.svg)]

---

# Cinder Architecture

## Host boundaries - remote driver (e.g. Ceph): remote storage device/backend.

.fill-width[![Insert graphic here](assets/architecture/architecture10.svg)]

---

template: section_layout

HIGH AVAILABILITY

---

# HA of Cinder services

## cinder-api

.left-column[
- Run multiple instances behind a HAProxy.
- Be advised of API race conditions in pre-Newton cinder-api.
]

.right-column[
![Insert graphic here](assets/ha/haproxy.svg)
]

---

# HA of Cinder services

## cinder-api race conditions

### Before

```python
vol = db.volume_get(ctxt, id)
if vol.status not in ('available', 'in-use'):
    db.volume_update(ctxt, id, status='retyping')
```

---

# HA of Cinder services

## cinder-api race conditions

### Before

```python
vol = db.volume_get(ctxt, id)
if vol.status not in ('available', 'in-use'):
    db.volume_update(ctxt, id, status='retyping')
```

### After

```python
expected = {'status': ('available', 'in-use')}
updates = {'status': 'retyping'}

if not volume.conditional_update(updates, expected, None):
    raise exception.InvalidVolume()
```

---

# HA of Cinder services

## cinder-scheduler

.left-column[
- You are be able to run multiple instances of cinder-scheduler in A/A fashion.
- Be advised that cinder-scheduler shares similar scaling issues as nova-scheduler.
]

.right-column[
![Insert graphic here](assets/ha/c-sch.svg)
]

---

# HA of Cinder services

## cinder-volume

TODO: To be extended by Gorka.

---

# HA of Cinder services

## cinder-backup

TODO: Gorka? Key talking points:
- Scalable backup service since Mitaka.
- Improvements related to c-vol A/A?

---

template: section_layout

ROLLING UPGRADES

---

# Rolling Upgrades

## Elements

- Online DB migrations (DB compatiblity).
- RPC API versioning (communication API compatibility).
- oslo.versionedobjects (communication payload compatiblity).

---

# Rolling Upgrades

## Elements

- Online DB migrations (DB compatiblity).
- RPC API versioning (communication API compatibility).
- oslo.versionedobjects (communication payload compatiblity).

## Assumptions

- Upgrade order: cinder-api, cinder-scheduler, cinder-volume, cinder-bakup.
- No release skipping.
- Continuous deployment from master is allowed.
- You can achieve live upgrade only if you have a HA deployment.

---

# Rolling Upgrades

## Elements

- Online DB migrations (DB compatiblity).
- RPC API versioning (communication API compatibility).
- oslo.versionedobjects (communication payload compatiblity).

## Assumptions

- Upgrade order: cinder-api, cinder-scheduler, cinder-volume, cinder-bakup.
- No release skipping.
- Continuous deployment from master is allowed.
- You can achieve live upgrade only if you have a HA deployment.

## Advices
- Having each service deployed in container makes things easier.
- Make sure there are no stale records in `services` table.
- Read the release notes before starting.

---

# Rolling Upgrades

## Upgrade procedure (X to X+1).

.fill-width[![Insert graphic here](assets/upgrades/upgrade1.svg)]

---

# Rolling Upgrades

## 1. Apply DB schema migrations.

.fill-width[![Insert graphic here](assets/upgrades/upgrade2.svg)]

---

# Rolling Upgrades

## 2. Upgrade cinder-api services one-by-one.

.fill-width[![Insert graphic here](assets/upgrades/upgrade3.svg)]

---

# Rolling Upgrades

## 2. Upgrade cinder-api services one-by-one.

.fill-width[![Insert graphic here](assets/upgrades/upgrade4.svg)]

---

# Rolling Upgrades

## 2. Upgrade cinder-api services one-by-one.

.fill-width[![Insert graphic here](assets/upgrades/upgrade5.svg)]

---

# Rolling Upgrades

## 2. Upgrade cinder-api services one-by-one.

.fill-width[![Insert graphic here](assets/upgrades/upgrade6.svg)]

---

# Rolling Upgrades

## 2. Upgrade cinder-api services one-by-one.

.fill-width[![Insert graphic here](assets/upgrades/upgrade7.svg)]

---

# Rolling Upgrades

## 3. Upgrade cinder-scheduler services one-by-one.

.fill-width[![Insert graphic here](assets/upgrades/upgrade8.svg)]

---

# Rolling Upgrades

## 3. Upgrade cinder-scheduler services one-by-one.

.fill-width[![Insert graphic here](assets/upgrades/upgrade9.svg)]

---

# Rolling Upgrades

## 3. Upgrade cinder-scheduler services one-by-one.

.fill-width[![Insert graphic here](assets/upgrades/upgrade10.svg)]

---

# Rolling Upgrades

## 4. Upgrade cinder-volume service.

.fill-width[![Insert graphic here](assets/upgrades/upgrade11.svg)]

---

# Rolling Upgrades

## 4. Upgrade cinder-volume service.

.fill-width[![Insert graphic here](assets/upgrades/upgrade12.svg)]

---

# Rolling Upgrades

## 5. Upgrade cinder-backup services one-by-one.

.fill-width[![Insert graphic here](assets/upgrades/upgrade13.svg)]

---

# Rolling Upgrades

## 5. Upgrade cinder-backup services one-by-one.

.fill-width[![Insert graphic here](assets/upgrades/upgrade14.svg)]

---

# Rolling Upgrades

## 5. Upgrade cinder-backup services one-by-one.

.fill-width[![Insert graphic here](assets/upgrades/upgrade15.svg)]

---

# Rolling Upgrades

## 5. Upgrade cinder-backup services one-by-one.

.fill-width[![Insert graphic here](assets/upgrades/upgrade16.svg)]

---

# Rolling Upgrades

## 6. Restart cinder-api services and send SIGHUP to the rest.

.fill-width[![Insert graphic here](assets/upgrades/upgrade17.svg)]

---

# Rolling Upgrades

## 7. Start applying online data migrations (Newton->Ocata upgrade).

.fill-width[![Insert graphic here](assets/upgrades/upgrade18.svg)]

---

# Rolling Upgrades

## Status in recent releases

| From release | To release | Status               |
|:------------:|:----------:|:--------------------:|
| Kilo         | Liberty    | Impossible           |
| Liberty      | Mitaka     | Experimental         |
| Mitaka       | Newton     | Experimental+        |
| Newton       | Ocata      | Supported and tested |

---

template: section_layout

STORAGE HIGH AVAILABILITY

---

# Replication v2.1

## Click to add subtitle

Insert paragraph of copy here. Do not exceed 40 words.

- Bullet
- Bullet
- Bullet

---

template: section_layout

CINDER INSIGHTS

---

# Common Bottlenecks

## Click to add subtitle

Insert paragraph of copy here. Do not exceed 40 words.

- Bullet
- Bullet
- Bullet

---

# Stopping Cinder

## The right way

Insert paragraph of copy here. Do not exceed 40 words.

- Bullet
- Bullet
- Bullet

---

# Changing Log Levels

## Without service interruption

Insert paragraph of copy here. Do not exceed 40 words.

- Bullet
- Bullet
- Bullet

---

template: section_layout

TEMPLATE SLIDE SAMPLES

---

# CLICK TO ADD TITLE

## Click to add subtitle

Insert paragraph of copy here. Do not exceed 40 words.

- Bullet
- Bullet
- Bullet

---

# TABLES

Tables are useful, blah, blah, blah.

.center.small-text[
Sample chart template]

| VALUE | VALUE | VALUE | VALUE |
|:-----:|:-----:|:-----:|:-----:|
| value | value | value | value |
| value | value | value | value |
| value | value | value | value |

.center.small-text[
Sample chart template]

.blue-table[
| VALUE | VALUE | VALUE | VALUE |
|:-----:|:-----:|:-----:|:-----:|
| value | value | value | value |
| value | value | value | value |
| value | value | value | value |
]

---

# CODE SNIPPET

When referencing code snippets, use the template below.<br/>
Resize the snippet box to the appropriate size for your text.

```python
# This program prints Hello, world!

print('Hello, world!')
```

---

# CLICK TO ADD TITLE

## Click to add subtitle

.left-column[
Insert paragraph of copy here. Do not exceed 40 words.

- Bullet
- Bullet
- Bullet
]

.right-column[
![Insert graphic here](assets/insert_graphic_here.png)
]

---

# CLICK TO ADD TITLE

## Click to add subtitle

.left-column[
![Insert graphic here](assets/insert_graphic_here.png)
]

.right-column[
Insert paragraph of copy here. Do not exceed 40 words.

- Bullet
- Bullet
- Bullet
]

---

# CLICK TO ADD TITLE

## Click to add subtitle

.left-column[
![Insert graphic here](assets/insert_graphic_here_small.png)
.center[
###COLUMN HEADING<br>ALL CAPS, TWO LINES AT MOST

Click to insert text
]
]

.right-column[
![Insert graphic here](assets/insert_graphic_here_small.png)

.center[
###COLUMN HEADING<br>ALL CAPS, TWO LINES AT MOST

Click to insert text
]
]

---

# CLICK TO ADD TITLE

## Click to add subtitle

.left-column.center[
###COLUMN HEADING<br>ALL CAPS, TWO LINES AT MOST

Click to insert text
]

.right-column.center[
###COLUMN HEADING<br>ALL CAPS, TWO LINES AT MOST

Click to insert text
]

---

# CLICK TO ADD TITLE

## Click to add subtitle

.left-column-3.center[
![Insert graphic here](assets/insert_graphic_here_small.png)
###COLUMN HEADING<br>ALL CAPS

Click to insert text
]

.middle-column-3.center[
![Insert graphic here](assets/insert_graphic_here_small.png)
###COLUMN HEADING<br>ALL CAPS

Click to insert text
]

.right-column-3.center[
![Insert graphic here](assets/insert_graphic_here_small.png)
###COLUMN HEADING<br>ALL CAPS

Click to insert text
]

---

# CLICK TO ADD TITLE

## Click to add subtitle

.left-column-3.center[
###COLUMN HEADING<br>ALL CAPS

Click to insert text
]

.middle-column-3.center[
###COLUMN HEADING<br>ALL CAPS

Click to insert text
]

.right-column-3.center[
###COLUMN HEADING<br>ALL CAPS

Click to insert text
]

---

# CLICK TO ADD TITLE

## Click to add subtitle

.center[Click to add text]


.fill-width[![Insert graphic here](assets/insert_graphic_here_small.png)]

---

# CLICK TO ADD TITLE

## Click to add subtitle

.fill-width[![Insert graphic here](assets/insert_graphic_here_small.png)]

.center[Click to add text]

---

# Legal Notices and Disclaimers

Intel disclaims all express and implied warranties, including without
limitation, the implied warranties of merchantability, fitness for a particular
purpose, and non-infringement, as well as any warranty arising from course of
performance, course of dealing, or usage in trade.

Intel, the Intel logo and others are trademarks of Intel Corporation in the
U.S. and/or other countries.

*Other names and brands may be claimed as the property of others.

---

template: thank_you

# THANK YOU

**Presentation available at:**

- http://github.com/intelsdi-x/cinder-always-on
- http://akrog.github.io/cinder_always_on

**Michal Dulko**

![email](assets/email.png)   [michal.dulko@intel.com](mailto:michal.dulko@intel.com)
![irc](assets/irc.png)   [dulek (freenode)](irc://chat.freenode.net/dulek,isnick)

**Gorka Eguileor**

![twitter](assets/twitter.png) [twitter.com/geguileo](https://twitter.com/geguileo)
![blog](assets/wp.png)   [gorka.eguileor.com](http://gorka.eguileor.com)

---

template: section_layout

![CC](assets/cc.svg)
.medium-text[
Except where otherwise noted, this work is licensed under

http://creativecommons.org/licenses/by/4.0/
]

    </textarea>
    <script src="remark.js" type="text/javascript"></script>
    <script type="text/javascript">
      var slideshow = remark.create({
        ratio: '16:9',
        slideNumberFormat: '%current%   <span class="designator"> Cinder Always On · Oct-2016 · BCN</span>',
        countIncrementalSlides: false
      });
    </script>
  </body>
</html>

<!-- vim: set ft=markdown : -->
